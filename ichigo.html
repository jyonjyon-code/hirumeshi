<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãã¿ã¯ä»Šæ—¥ã„ã¡ã”ã‚’é£Ÿã¹ãŸã‹ | ä»Šæ—¥ã‚¤ãƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; text-align: center; background: #fff5f6; padding: 15px; color: #4a1a1a; margin: 0; }
        .card { background: white; padding: 25px 20px; border-radius: 30px; box-shadow: 0 10px 30px rgba(255,100,120,0.15); display: inline-block; width: 100%; max-width: 400px; border: 4px solid #ff4d6d; box-sizing: border-box; }
        .main-title { color: #ff4d6d; font-size: 20px; margin-bottom: 5px; font-weight: 900; line-height: 1.3; white-space: nowrap; }
        .sub-nickname { font-size: 26px; color: #ff4d6d; margin-bottom: 20px; display: block; font-weight: 900; background: #fff0f3; border-radius: 12px; padding: 8px; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #auth-section { margin-bottom: 15px; }
        .btn-login { background: white; color: #444; border: 1px solid #ddd; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .user-info { font-size: 13px; color: #ff4d6d; margin-bottom: 10px; display: none; background: #fff; padding: 5px; border-radius: 8px; font-weight: bold; }

        .counter-group { background: #fffcfc; border-radius: 20px; padding: 10px 15px; margin-bottom: 10px; border: 1px solid #ffe5e9; }
        .item-row { display: flex; align-items: center; justify-content: space-between; margin: 12px 0; padding-bottom: 8px; border-bottom: 1px dashed #ffe5e9; }
        .item-row:last-child { border-bottom: none; }
        .item-label { font-size: 14px; font-weight: bold; flex-grow: 1; text-align: left; }
        .sweet-select { font-family: 'Zen Maru Gothic', sans-serif; font-size: 13px; padding: 8px; border-radius: 10px; border: 1px solid #ff4d6d; margin-top: 8px; width: 100%; color: #4a1a1a; background: white; }
        .controls { display: flex; align-items: center; gap: 8px; }
        .count-num { font-size: 18px; font-weight: 900; min-width: 25px; }
        .btn-plus { width: 42px; height: 42px; border-radius: 50%; border: none; background: #ff4d6d; color: white; font-size: 22px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 0 #c92a42; }
        .btn-minus { width: 34px; height: 34px; border-radius: 50%; border: 2px solid #ff4d6d; background: white; color: #ff4d6d; font-size: 18px; cursor: pointer; font-weight: bold; }
        .btn-main { background: #ff4d6d; color: white; border: none; padding: 15px 30px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 18px; width: 100%; margin-top: 15px; box-shadow: 0 4px 0 #c92a42; transition: 0.2s; }
        
        #judgment-area { display: none; margin-top: 20px; padding: 20px; background: #fffbf0; border-radius: 20px; border: 2px dashed #ff4d6d; }
        .shogo { font-size: 22px; font-weight: 900; color: #ff4d6d; }
        .studio-nav { margin-top: 20px; border-top: 1px solid #ffe5e9; padding-top: 20px; }
        .btn-nav { display: block; margin-bottom: 10px; color: #ff4d6d; text-decoration: none; font-size: 14px; font-weight: bold; border: 2px solid #ff4d6d; padding: 12px; border-radius: 15px; }
        .btn-share { background: #000; color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="card">
    <div class="main-title">ãã¿ã¯ä»Šæ—¥ ã„ã¡ã”ã‚’é£Ÿã¹ãŸã‹</div>
    <div class="sub-nickname">ä»Šæ—¥ã‚¤ãƒ</div>

    <div id="auth-section">
        <button id="btn-login" class="btn-login">
            <i class="fa-brands fa-google"></i> Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦åŒæœŸ
        </button>
        <div id="user-info" class="user-info"></div>
    </div>

    <div class="counter-group">
        <div class="item-row">
            <div class="item-label">ğŸ“ ç”Ÿã®ã„ã¡ã”</div>
            <div class="controls">
                <button class="btn-minus" onclick="change('raw', -1)">âˆ’</button>
                <span class="count-num" id="raw-count">0</span>
                <button class="btn-plus" onclick="change('raw', 1)">ï¼‹</button>
            </div>
        </div>
        <div class="item-row">
            <div class="item-label">ğŸ¥„ ã‚¸ãƒ£ãƒ (æ¯)</div>
            <div class="controls">
                <button class="btn-minus" onclick="change('jam', -1)">âˆ’</button>
                <span class="count-num" id="jam-count">0</span>
                <button class="btn-plus" onclick="change('jam', 1)">ï¼‹</button>
            </div>
        </div>
        <div class="item-row" style="flex-direction: column; align-items: flex-start;">
            <div style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
                <div class="item-label">ğŸ° ã‚¹ã‚¤ãƒ¼ãƒ„ç³»</div>
                <div class="controls">
                    <button class="btn-minus" onclick="change('sweet', -1)">âˆ’</button>
                    <span class="count-num" id="sweet-count">0</span>
                    <button class="btn-plus" onclick="change('sweet', 1)">ï¼‹</button>
                </div>
            </div>
            <select id="sweet-type" class="sweet-select">
                <option value="2.0">ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ (2.0ğŸ“)</option>
                <option value="3.0">ã„ã¡ã”ãƒ‘ãƒ•ã‚§ (3.0ğŸ“)</option>
                <option value="1.5">ã„ã¡ã”å¤§ç¦ (1.5ğŸ“)</option>
                <option value="1.0">ã„ã¡ã”ãƒãƒ§ã‚³ (1.0ğŸ“)</option>
            </select>
        </div>
    </div>

    <button class="btn-main" onclick="judge()">æ‘‚å–é‡ã‚’å ±å‘Šã™ã‚‹</button>

    <div id="judgment-area">
        <div class="shogo" id="shogo-text"></div>
        <p id="comment-text" style="font-size:14px; color:#7a4a4a; white-space: pre-wrap;"></p>
        <button onclick="shareOnX()" class="btn-share">
            <i class="fa-brands fa-x-twitter"></i> ãƒ©ãƒ³ã‚¯ã‚’å ±å‘Šã™ã‚‹
        </button>
    </div>

    <div class="studio-nav">
        <a href="ichigo_log.html" class="btn-nav">ğŸ—“ï¸ å±¥æ­´ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¦‹ã‚‹</a>
        <a href="index.html" style="color:#888; font-size:12px; text-decoration:none;">ã­ã“ãŸã‚¹ã‚¿ã‚¸ã‚ªã¸æˆ»ã‚‹</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // éµã•ã‚“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic",
        authDomain: "necotastudio-app.firebaseapp.com",
        projectId: "necotastudio-app",
        storageBucket: "necotastudio-app.firebasestorage.app",
        messagingSenderId: "1093173509944",
        appId: "1:1093173509944:web:5340935ddffdd49628cbcd",
        measurementId: "G-W1NP66L6D4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let counts = { raw: 0, jam: 0, sweet: 0 };

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    document.getElementById('btn-login').onclick = async () => {
        try {
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Login failed", error);
            alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Authenticationã§Googleãƒ­ã‚°ã‚¤ãƒ³ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã€æ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã«github.ioãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    };

    // ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('user-info').innerText = `ğŸ“ ${user.displayName} ã•ã‚“ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;
        }
    });

    window.change = (type, delta) => {
        counts[type] = Math.max(0, counts[type] + delta);
        document.getElementById(type + '-count').innerText = counts[type];
    };

    window.judge = async () => {
        const sweetMultiplier = parseFloat(document.getElementById('sweet-type').value);
        let addScore = (counts.raw * 1.0) + (counts.jam * 0.5) + (counts.sweet) * sweetMultiplier;
        if (addScore === 0) return alert("ã„ã¡ã”ã‚’æ‘‚å–ã—ã¦ã‹ã‚‰å ±å‘Šã—ã¦ãã ã•ã„ğŸ“");

        const now = new Date();
        const dateStr = `${now.getMonth()+1}/${now.getDate()}`;
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
        let history = JSON.parse(localStorage.getItem('ichigo-history') || '[]');
        history.unshift({ score: addScore, date: dateStr, timestamp: now.getTime() });
        localStorage.setItem('ichigo-history', JSON.stringify(history.slice(0, 100)));
        const dayTotal = history.reduce((s, h) => s + h.score, 0);

        // ã€ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã€‘ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰Firebaseã¸
        if (currentUser) {
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await setDoc(userRef, {
                    history: arrayUnion({
                        date: dateStr,
                        score: addScore,
                        timestamp: now.toISOString()
                    }),
                    lastUpdate: new Date().toISOString()
                }, { merge: true });
            } catch (e) {
                console.error("Cloud save error:", e);
            }
        }

        let shogo = addScore >= 10 ? "ã„ã¡ã”ã®åŒ–èº«" : addScore >= 5 ? "ã„ã¡ã”é¨å£«" : "ã„ã¡ã”æ„›å¥½å®¶";
        document.getElementById('shogo-text').innerText = "ã€" + shogo + "ã€‘";
        document.getElementById('comment-text').innerText = `ä»Šå›: +${addScore.toFixed(1)}ğŸ“\nåˆè¨ˆ: ${dayTotal.toFixed(1)}ğŸ“`;
        document.getElementById('judgment-area').style.display = 'block';
        
        // ãƒªã‚»ãƒƒãƒˆ
        counts = { raw: 0, jam: 0, sweet: 0 };
        ['raw','jam','sweet'].forEach(k => document.getElementById(k+'-count').innerText = 0);
    };

    window.shareOnX = () => {
        const text = encodeURIComponent(`ã€${document.getElementById('shogo-text').innerText}ã€‘ã«ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ï¼ä»Šæ—¥ã®ã„ã¡ã”æ‘‚å–é‡ã‚’å ±å‘Šã—ã¾ã—ãŸğŸ“\n#ä»Šæ—¥ã‚¤ãƒ #ã­ã“ãŸã‚¹ã‚¿ã‚¸ã‚ª\n`);
        const url = encodeURIComponent(window.location.href);
        window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
    };
</script>
</body>
</html>
