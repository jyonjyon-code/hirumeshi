<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã„ã¡ã”è¨˜éŒ²å¸³ | ä»Šæ—¥ã‚¤ãƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; text-align: center; background: #fff5f6; padding: 20px; color: #4a1a1a; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 30px; box-shadow: 0 10px 30px rgba(255,100,120,0.15); display: inline-block; width: 95%; max-width: 400px; border: 4px solid #ff4d6d; box-sizing: border-box; }
        .stats-box { background: #4a1a1a; color: #fff; border-radius: 15px; padding: 15px; margin-bottom: 20px; text-align: left; position: relative; }
        .stats-val { font-size: 20px; font-weight: 900; color: #ff4d6d; }
        .btn-stats-share { position: absolute; top: 15px; right: 15px; background: #fff; color: #000; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #fffcfc; border: 1px solid #ffe5e9; padding: 5px; border-radius: 15px; margin-bottom: 20px; }
        .calendar-day { font-size: 10px; height: 50px; background: white; border-radius: 5px; display: flex; flex-direction: column; align-items: center; padding-top: 4px; border: 1px solid #fff5f6; }
        .cal-score { font-size: 9px; color: #ff4d6d; font-weight: 900; margin-top: 2px; }
        .cal-header { font-size: 10px; font-weight: bold; color: #ff85a1; padding: 5px 0; }

        .history-item { font-size: 12px; padding: 10px 8px; border-bottom: 1px solid #ffeef0; display: flex; align-items: center; justify-content: space-between; }
        .history-info { display: flex; flex-direction: column; text-align: left; flex-grow: 1; }
        .history-date { font-weight: bold; color: #ff4d6d; font-size: 13px; }
        .history-time { color: #888; font-size: 10px; margin-left: 5px; font-weight: normal; }
        .history-shogo { color: #666; font-size: 11px; }
        .history-score { font-weight: 900; color: #4a1a1a; margin-right: 15px; }

        .btn-del-item { background: #eee; color: #888; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer; line-height: 22px; padding: 0; }
        
        .studio-nav { margin-top: 20px; border-top: 1px solid #ffe5e9; padding-top: 20px; }
        .btn-back { display: block; margin-bottom: 10px; color: white; background: #ff4d6d; text-decoration: none; padding: 12px; border-radius: 50px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 0 #c92a42; text-align: center; }
        .sns-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-sns { color: white; border: none; padding: 10px; border-radius: 50px; cursor: pointer; font-weight: bold; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; flex: 1; }
        .btn-x { background: #000; }
        .btn-insta { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        
        .btn-delete-all { color: #cc0000; font-size: 11px; background: none; border: none; text-decoration: underline; cursor: pointer; float: right; }
        #loading-msg { font-size: 12px; color: #ff4d6d; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
<div class="card">
    <h1 style="color:#ff4d6d; font-size:22px; margin-top:0;">ğŸ—“ï¸ ã„ã¡ã”è¨˜éŒ²å¸³</h1>
    <div id="loading-msg">ã‚¯ãƒ©ã‚¦ãƒ‰ã¨åŒæœŸä¸­...ğŸ“</div>
    
    <div class="stats-box">
        <div style="font-size:11px; color:#ff85a1; font-weight:bold;">ç´¯è¨ˆè¦³æ¸¬ãƒ‡ãƒ¼ã‚¿</div>
        <div style="margin: 5px 0;">ä»Šæœˆã®åˆè¨ˆ: <span class="stats-val" id="month-total">0.0</span> ğŸ“</div>
        <div style="margin: 5px 0;">å…¨ç´¯è¨ˆ: <span class="stats-val" id="all-total">0.0</span> ğŸ“</div>
        <div id="total-rank" style="color:#ffd700; font-weight:bold; font-size:13px; margin-top:5px;">å±æ€§: ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
        <button class="btn-stats-share" onclick="shareStats()" title="ç´¯è¨ˆã‚’ã‚·ã‚§ã‚¢"><i class="fa-brands fa-x-twitter"></i></button>
    </div>

    <div id="calendar-month" style="font-size:14px; font-weight:bold; color:#ff4d6d; margin-bottom:5px;"></div>
    <div class="calendar-grid" id="calendar-grid"></div>

    <h3 style="font-size:16px; color:#ff4d6d; text-align:left; border-bottom:2px solid #ff4d6d; padding-bottom:5px;">
        ğŸ“ è¦³æ¸¬ãƒ­ã‚°ï¼ˆå€‹åˆ¥ï¼‰
        <button class="btn-delete-all" onclick="clearHistory()">å…¨æ¶ˆå»</button>
    </h3>
    <div id="history-list"></div>

    <div class="studio-nav">
        <a href="ichigo.html" class="btn-back">ã„ã¡ã”ã‚’å ±å‘Šã—ã«è¡Œã</a>
        <div class="sns-group">
            <a href="https://x.com/necotatu2" target="_blank" class="btn-sns btn-x">
                <i class="fa-brands fa-x-twitter"></i> å…¬å¼X
            </a>
            <a href="https://www.instagram.com/necotastudio" target="_blank" class="btn-sns btn-insta">
                <i class="fa-brands fa-instagram"></i> å…¬å¼Insta
            </a>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic",
        authDomain: "necotastudio-app.firebaseapp.com",
        projectId: "necotastudio-app",
        storageBucket: "necotastudio-app.firebasestorage.app",
        messagingSenderId: "1093173509944",
        appId: "1:1093173509944:web:5340935ddffdd49628cbcd",
        measurementId: "G-W1NP66L6D4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            renderFromCloud(user);
        } else {
            document.getElementById('loading-msg').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™";
        }
    });

    async function renderFromCloud(user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        
        let history = [];
        if (userSnap.exists() && userSnap.data().history) {
            history = userSnap.data().history;
        }
        
        // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒä¸Šï¼‰
        history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); 
        
        let mTotal = 0, aTotal = 0;
        let dailyTotals = {}; 

        history.forEach(h => {
            const s = Number(h.score) || 0;
            const dateObj = new Date(h.timestamp);
            aTotal += s;
            
            // ä»Šæœˆã®åˆè¨ˆè¨ˆç®—
            if(dateObj.getFullYear() === year && dateObj.getMonth() === month) {
                mTotal += s;
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨é›†è¨ˆ (YYYY-M-Då½¢å¼)
            const dateKey = `${dateObj.getFullYear()}-${dateObj.getMonth() + 1}-${dateObj.getDate()}`;
            dailyTotals[dateKey] = (dailyTotals[dateKey] || 0) + s;
        });

        document.getElementById('month-total').innerText = mTotal.toFixed(1);
        document.getElementById('all-total').innerText = aTotal.toFixed(1);
        document.getElementById('loading-msg').style.display = 'none';
        
        let rank = aTotal >= 300 ? "ğŸ“ ã„ã¡ã”ã®ç¥æ§˜" : aTotal >= 50 ? "ã„ã¡ã”è²´æ—" : aTotal >= 10 ? "ã„ã¡ã”å›½æ°‘" : "ã„ã¡ã”å¸‚æ°‘";
        document.getElementById('total-rank').innerText = "ç¾åœ¨ã®å±æ€§: " + rank;

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        let html = '';
        ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => html += `<div class="cal-header">${d}</div>`);
        
        for(let i=0; i<firstDay; i++) html += '<div></div>';
        for(let d=1; d<=lastDate; d++){
            const targetKey = `${year}-${month + 1}-${d}`;
            const dayScore = dailyTotals[targetKey];
            html += `<div class="calendar-day">${d}${dayScore ? `<div class="cal-score">${dayScore.toFixed(1)}ğŸ“</div>` : ''}</div>`;
        }
        document.getElementById('calendar-grid').innerHTML = html;
        document.getElementById('calendar-month').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        // ãƒ­ã‚°ãƒªã‚¹ãƒˆæç”» (æ™‚é–“ãŒundefinedã«ãªã‚‰ãªã„ã‚ˆã†ã«ä¿®æ­£)
        const listHtml = history.map((h, index) => {
            const dateObj = new Date(h.timestamp);
            const timeStr = isNaN(dateObj) ? "--:--" : `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2, '0')}`;
            const dateStr = h.date || `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
            const shogo = h.score >= 10 ? "ã„ã¡ã”ã®åŒ–èº«" : h.score >= 5 ? "ã„ã¡ã”é¨å£«" : "ã„ã¡ã”æ„›å¥½å®¶";
            
            return `
                <div class="history-item">
                    <div class="history-info">
                        <span class="history-date">${dateStr}<span class="history-time">${timeStr}</span></span>
                        <span class="history-shogo">${shogo}</span>
                    </div>
                    <span class="history-score">${Number(h.score).toFixed(1)}ğŸ“</span>
                    <button class="btn-del-item" onclick="deleteSingleEntry('${h.timestamp}')">Ã—</button>
                </div>
            `;
        }).join('');
        document.getElementById('history-list').innerHTML = listHtml || '<div style="color:#ccc;font-size:12px;margin-top:10px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.deleteSingleEntry = async (timestamp) => {
        if(confirm("ã“ã®1ä»¶ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            const user = auth.currentUser;
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const newHistory = userSnap.data().history.filter(h => h.timestamp !== timestamp);
                await updateDoc(userRef, { history: newHistory });
                location.reload();
            }
        }
    }

    window.clearHistory = async () => {
        if(confirm("ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            const user = auth.currentUser;
            const userRef = doc(db, "users", user.uid);
            await updateDoc(userRef, { history: [] });
            location.reload();
        }
    }

    window.shareStats = () => {
        const aTotal = document.getElementById('all-total').innerText;
        const rank = document.getElementById('total-rank').innerText;
        const text = `ã€ä»Šæ—¥ã‚¤ãƒ è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã€‘\nç´¯è¨ˆæ‘‚å–é‡ï¼š${aTotal} ğŸ“\n${rank}\nã„ã¡ã”ã®è¦³æ¸¬ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚ğŸ“\n#ä»Šæ—¥ã‚¤ãƒ #ã„ã¡ã” #ã­ã“ãŸã‚¹ã‚¿ã‚¸ã‚ª`;
        const url = "https://jyonjyon-code.github.io/hirumeshi/ichigo.html";
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
    }
</script>
</body>
</html>
